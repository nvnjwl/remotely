import{M as MessageTypes,T as Transport,$ as $dd0187d7f28e386f$export$2e2bcd8739ae039,_ as __vitePreload}from"./assets/preload-helper-XiwAX_5I.js";function send(e,r){const t=getSdkTransport();t?.send(e,r,{from:t?.peer?.id})}function handleIncoming(msg){if(msg.type===MessageTypes.CMD){const{code,id}=msg.payload;try{const value=eval(code);send(MessageTypes.CMD_RESULT,{id,success:!0,value:serialize(value)})}catch(e){send(MessageTypes.CMD_RESULT,{id,success:!1,error:String(e)})}}}function serialize(e){if(e===void 0)return"undefined";if(typeof e=="function")return e.toString().slice(0,200);try{return JSON.stringify(e)}catch{return String(e)}}function snapshotStorage(){const e={};for(let r=0;r<localStorage.length;r++){const t=localStorage.key(r);e[t]=localStorage.getItem(t)}send(MessageTypes.STORAGE,e)}function watchStorage(){snapshotStorage(),window.addEventListener("storage",snapshotStorage)}let transport=null,secret=null;function initSdkTransport(e,r,t={}){secret=t.secret||null,transport=new Transport(n=>new $dd0187d7f28e386f$export$2e2bcd8739ae039(n,t.peer||{}),{onMessage,debug:t.debug}),transport.init(e),transport.onOpen(()=>{}),transport.peer.on("open",()=>{r&&(transport.connect(r),setTimeout(()=>sendHandshake(),300))})}function onMessage(e){if(e.type===MessageTypes.HANDSHAKE){if(secret&&e.payload?.secret!==secret)return;!localStorage.getItem("controllerId")&&e.meta?.from&&localStorage.setItem("controllerId",e.meta.from);return}handleIncoming(e)}function getSdkTransport(){return transport}function sendHandshake(){transport?.send(MessageTypes.HANDSHAKE,{secret}),snapshotStorage()}function hijackConsole(){["log","error","warn","info"].forEach(e=>{const r=console[e];console[e]=function(...t){try{send(MessageTypes.LOG,{level:e,message:t.map(n=>format(n)).join(" ")})}catch{}return r.apply(this,t)}})}function format(e){if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function installFetchProxy(){const e=window.fetch;window.fetch=async function(r,t){const n=performance.now(),a=t&&t.method||"GET",c=typeof r=="string"?r:r.url,o=Math.random().toString(36).slice(2);send(MessageTypes.NET_REQ,{id:o,method:a,url:c,ts:Date.now()});try{const s=await e.apply(this,arguments),i=s.clone();let d="";try{d=await i.text()}catch{}return send(MessageTypes.NET_RES,{id:o,status:s.status,duration:+(performance.now()-n).toFixed(1),bodySnippet:d.slice(0,500)}),s}catch(s){throw send(MessageTypes.NET_RES,{id:o,status:"ERR",error:String(s),duration:+(performance.now()-n).toFixed(1)}),s}}}function installXHRProxy(){const e=window.XMLHttpRequest;function r(){const t=new e,n=Math.random().toString(36).slice(2);let a="",c="";const o=performance.now();return t._open=t.open,t.open=function(s,i){c=s,a=i,t._open(s,i,!0)},t.addEventListener("loadstart",()=>{send(MessageTypes.NET_REQ,{id:n,method:c,url:a,ts:Date.now()})}),t.addEventListener("loadend",()=>{send(MessageTypes.NET_RES,{id:n,status:t.status,duration:+(performance.now()-o).toFixed(1),bodySnippet:(t.responseText||"").slice(0,500)})}),t.addEventListener("error",()=>{send(MessageTypes.NET_RES,{id:n,status:"ERR",duration:+(performance.now()-o).toFixed(1)})}),t}window.XMLHttpRequest=r}let started$1=!1;async function startRrweb(){if(started$1)return;started$1=!0,(await __vitePreload(()=>import("./assets/rrweb-DnApGbsL.js"),[])).record({emit(r){send(MessageTypes.RRWEB_EVENT,r)},sampling:{scroll:200,mousemove:100}})}let started=!1;function startDebugSession(e={}){if(started)return;started=!0;const r=e.selfId||localStorage.getItem("CPID")||"sdk-"+Math.random().toString(36).slice(2,8),t=e.controllerId||localStorage.getItem("controllerId");initSdkTransport(r,t,{secret:e.secret}),hijackConsole(),e.network!==!1&&(installFetchProxy(),installXHRProxy()),e.storage!==!1&&watchStorage(),e.rrweb&&startRrweb(),window.addEventListener("error",n=>{send(MessageTypes.LOG,{level:"error",message:n.message})})}const DEBUG_MODE={startDebugSession};window.DEBUG_MODE=DEBUG_MODE;
